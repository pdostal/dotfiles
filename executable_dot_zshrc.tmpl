# vim: ft=zsh

{{- include "private_dot_secrets/zshrc" -}}

# Lines configured by zsh-newuser-install
HISTFILE=~/.histfile
HISTSIZE=1000
SAVEHIST=99999999
setopt beep extendedglob nomatch
unsetopt notify
bindkey -e
# End of lines configured by zsh-newuser-install
# The following lines were added by compinstall
zstyle :compinstall filename '/home/pavel/.zshrc'

autoload -Uz compinit
compinit
# End of lines added by compinstall

unsetopt AUTO_REMOVE_SLASH

test -d "/opt/homebrew/opt/coreutils/libexec/gnubin/" && export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin/:$PATH"
test -d "/usr/local/bin" && export PATH="/usr/local/bin:$PATH"
test -d "$HOME/bin" && export PATH="$HOME/bin:$PATH"

test -f /opt/homebrew/bin/brew && eval $(/opt/homebrew/bin/brew shellenv)
test -e ${HOME}/.iterm2_shell_integration.zsh && source ${HOME}/.iterm2_shell_integration.zsh

if [[ "$myPrimaryDevice" == "1" ]]; then
  SSH_ENV="$HOME/.ssh/agent.env"
  start_agent() {
    eval "$(ssh-agent -s)" >/dev/null
    {
      echo "export SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
      echo "export SSH_AGENT_PID=$SSH_AGENT_PID"
    } >| "$SSH_ENV"
    chmod 600 "$SSH_ENV"
    # Add keys only when agent starts
    ssh-add
  }
  valid_agent() {
    kill -0 "$SSH_AGENT_PID" 2>/dev/null || return 1
    [[ -S "$SSH_AUTH_SOCK" ]] || return 1
    case "$(ps -p "$SSH_AGENT_PID" -o comm= 2>/dev/null)" in
      ssh-agent|*/ssh-agent) return 0 ;;
      *) return 1 ;;
    esac
  }
  if [[ -r "$SSH_ENV" ]]; then
    source "$SSH_ENV" >/dev/null
    if ! valid_agent; then
      rm -f "$SSH_ENV"
      start_agent
    fi
  else
    start_agent
  fi
fi

# NeoVim
if command -v nvim &> /dev/null; then
  export EDITOR="nvim"
  alias vim='nvim'
elif command -v vim &> /dev/null; then
  export EDITOR="vim"
else
  if [[ -o interactive ]]; then
    echo "Install NeoVim or Vim\!"
  fi
fi

test -d "$HOME/.local/share/sheldon/repos/github.com/ohmyzsh/ohmyzsh" &> /dev/null && export ZSH="$HOME/.local/share/sheldon/repos/github.com/ohmyzsh/ohmyzsh"
ZSH_THEME=dpoggi

eval "$(sheldon source)"
eval "$(zoxide init zsh)"

export WORDCHARS=${WORDCHARS/\/}
# source ~/.git-prompt.zsh

if command -v kubecolor &> /dev/null && command -v kubectl &> /dev/null; then
  source <(kubectl completion zsh)
  alias kubectl=kubecolor
  compdef kubecolor=kubectl
  alias k=kubecolor
  compdef k=kubectl
elif command -v kubectl &> /dev/null; then
  source <(kubectl completion zsh)
  alias k=kubectl
  compdef k=kubectl
fi

if typeset -f kube_ps1 > /dev/null; then
  PROMPT='$(kube_ps1)'$PROMPT
  export KUBE_PS1_PREFIX=''
  export KUBE_PS1_SUFFIX=' '
  export KUBE_PS1_SYMBOL_ENABLE=false
fi

alias podman-az='podman run --rm -it --name azure-cli --replace -v ~/.ssh:/root/.ssh:z -v ~/.azure:/root/.azure:z mcr.microsoft.com/azure-cli az'
alias ll='ls -lah'
if command -v z &> /dev/null; then alias cd='z'; fi
if command -v git &> /dev/null; then alias g='git'; fi
if command -v bat &> /dev/null; then alias cat='bat -p'; fi

alias mosh='MOSH_TITLE_NOPREFIX=true mosh'
alias mtr='sudo mtr'
alias susepkg='podman run -it ghcr.io/ricardobranco777/susepkg:latest'

sshtmux() { ssh -t "$1" tmux attach; }
sshauto() { autossh -t -M 0 "$1"; }
sshtmuxauto() { autossh -t -M 0 "$1" tmux attach; }
moshtmux() { ssh "$1" 'kill `pidof mosh-server` >/dev/null 2>&1'; mosh "$1" tmux attach; }

if [ -f ~/.local/google-cloud-sdk/path.zsh.inc ]; then . ~/.local/google-cloud-sdk/path.zsh.inc; fi
if [ -f ~/.local/google-cloud-sdk/completion.zsh.inc ]; then . ~/.local/google-cloud-sdk/completion.zsh.inc; fi
if [ -f '/opt/google-cloud-sdk/path.zsh.inc' ]; then . '/opt/google-cloud-sdk/path.zsh.inc'; fi
if [ -f '/opt/google-cloud-sdk/completion.zsh.inc' ]; then . '/opt/google-cloud-sdk/completion.zsh.inc'; fi

if [[ -o interactive ]]; then
  command -v motd &> /dev/null && motd
fi

